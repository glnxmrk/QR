<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AttendancePro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        glass: "rgba(255, 255, 255, 0.1)",
                        glassBorder: "rgba(255, 255, 255, 0.2)",
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
            background-attachment: fixed;
            -webkit-font-smoothing: antialiased;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .glass-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.3);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .glass-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .glass-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Nav active state */
        .nav-active {
            background: rgba(255, 255, 255, 0.25);
            border-top: 2px solid white;
            color: white !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
    </style>
</head>

<body class="text-white min-h-screen flex flex-col overflow-hidden">

    <!-- Header (Desktop) / Top Bar -->
    <header class="p-4 flex justify-between items-center glass-panel border-b border-white/10 z-20">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                <i class="fa-solid fa-qrcode text-xl text-white"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Attendance<span class="text-cyan-300">Pro</span></h1>
                <p class="text-xs text-blue-200">System Ready</p>
            </div>
        </div>
        <button onclick="toggleModal('modal-settings')"
            class="w-10 h-10 rounded-full glass-btn flex items-center justify-center text-white/80 hover:text-white">
            <i class="fa-solid fa-gear"></i>
        </button>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow relative overflow-hidden">

        <!-- View: SCANNER -->
        <section id="view-scan"
            class="absolute inset-0 p-4 pb-24 overflow-y-auto view-section transition-all duration-300">
            <div class="max-w-md mx-auto space-y-4">

                <!-- Camera Card -->
                <div class="glass-panel rounded-3xl overflow-hidden p-1 relative">
                    <div
                        class="relative bg-black/50 rounded-2xl overflow-hidden aspect-[1/1] sm:aspect-video md:aspect-[4/3] flex flex-col items-center justify-center">
                        <div id="reader" class="w-full h-full object-cover"></div>

                        <!-- Camera Placeholder -->
                        <div id="camera-placeholder"
                            class="absolute inset-0 flex flex-col items-center justify-center text-white/50">
                            <div
                                class="w-16 h-16 rounded-full border-2 border-white/20 flex items-center justify-center mb-3">
                                <i class="fa-solid fa-camera text-2xl"></i>
                            </div>
                            <p class="text-sm">Camera Inactive</p>
                            <p class="text-xs text-white/30 mt-1">Tap start to scan</p>
                        </div>
                    </div>

                    <!-- Scan Controls -->
                    <div class="absolute bottom-4 left-0 right-0 p-4 flex justify-center gap-4 z-10">
                        <div id="controls-inactive" class="flex gap-2">
                            <button onclick="startScanner()"
                                class="bg-cyan-500 hover:bg-cyan-400 text-white px-6 py-3 rounded-full font-semibold shadow-lg shadow-cyan-500/30 transition-all active:scale-95 flex items-center gap-2">
                                <i class="fa-solid fa-play"></i> Scan
                            </button>
                        </div>
                        <div id="controls-active" class="hidden flex gap-2">
                            <select id="camera-select" onchange="restartScanner()"
                                class="glass-btn px-4 py-2 rounded-full text-sm text-white focus:outline-none appearance-none pr-8 relative">
                                <option value="environment">Back Camera</option>
                                <option value="user">Front Camera</option>
                            </select>
                            <button onclick="stopScanner()"
                                class="bg-red-500/80 hover:bg-red-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all active:scale-95">
                                <i class="fa-solid fa-stop"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Feedback Area -->
                <div class="space-y-2">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-blue-200 ml-1">Recent Activity</h3>
                    <div id="live-feedback" class="space-y-2 min-h-[100px]">
                        <!-- Dynamic items -->
                        <div class="glass-panel rounded-xl p-4 flex items-center gap-3 animate-pulse">
                            <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                                <i class="fa-solid fa-clock text-white/50"></i>
                            </div>
                            <div class="text-sm text-white/50">Ready to scan...</div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- View: LEARNERS -->
        <section id="view-learners"
            class="absolute inset-0 p-4 pb-24 overflow-y-auto view-section translate-x-full transition-all duration-300 hidden">
            <div class="max-w-2xl mx-auto space-y-4">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <h2 class="text-2xl font-bold">Learners</h2>
                        <p class="text-white/60 text-sm">Manage student database</p>
                    </div>
                    <button onclick="toggleModal('modal-add-learner')"
                        class="bg-white text-blue-900 px-4 py-2 rounded-lg font-bold text-sm shadow-lg active:scale-95 transition-all">
                        <i class="fa-solid fa-plus mr-1"></i> Add
                    </button>
                </div>

                <div id="learners-list" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- View: LOGS -->
        <section id="view-logs"
            class="absolute inset-0 p-4 pb-24 overflow-y-auto view-section translate-x-full transition-all duration-300 hidden">
            <div class="max-w-2xl mx-auto space-y-4">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <h2 class="text-2xl font-bold">Logs</h2>
                        <p class="text-white/60 text-sm">Attendance history</p>
                    </div>
                    <button onclick="exportLogs()"
                        class="glass-btn px-4 py-2 rounded-lg font-medium text-sm text-white/90">
                        <i class="fa-solid fa-download mr-1"></i> CSV
                    </button>
                </div>

                <div class="glass-panel rounded-2xl overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-white/10 text-blue-100 uppercase text-xs font-semibold">
                            <tr>
                                <th class="p-3">Time</th>
                                <th class="p-3">Name</th>
                                <th class="p-3 text-right">Status</th>
                            </tr>
                        </thead>
                        <tbody id="logs-list" class="divide-y divide-white/10">
                            <!-- Populated JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- Mobile Navigation (Bottom) -->
    <nav class="fixed bottom-0 left-0 right-0 glass-panel border-t border-white/10 pb-safe z-30">
        <div class="flex justify-around items-center h-16 max-w-md mx-auto">
            <button onclick="navSwitch('scan')" id="btn-scan"
                class="flex flex-col items-center justify-center w-full h-full text-white/60 hover:text-white transition-colors nav-active">
                <i class="fa-solid fa-expand text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-wide">SCAN</span>
            </button>
            <button onclick="navSwitch('learners')" id="btn-learners"
                class="flex flex-col items-center justify-center w-full h-full text-white/60 hover:text-white transition-colors">
                <i class="fa-solid fa-user-group text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-wide">LEARNERS</span>
            </button>
            <button onclick="navSwitch('logs')" id="btn-logs"
                class="flex flex-col items-center justify-center w-full h-full text-white/60 hover:text-white transition-colors">
                <i class="fa-solid fa-list-check text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-wide">LOGS</span>
            </button>
        </div>
    </nav>

    <!-- MODALS -->

    <!-- Add Learner Modal -->
    <div id="modal-add-learner"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div
            class="glass-panel bg-slate-900/90 rounded-2xl w-full max-w-sm p-6 transform transition-all shadow-2xl border-white/20">
            <h3 class="text-xl font-bold mb-4">New Learner</h3>
            <form onsubmit="addLearner(event)" class="space-y-4">
                <input type="text" name="name" required placeholder="Full Name"
                    class="glass-input w-full p-3 rounded-xl placeholder-white/30">
                <input type="text" name="section" required placeholder="Section"
                    class="glass-input w-full p-3 rounded-xl placeholder-white/30">
                <div class="space-y-1">
                    <input type="tel" name="parent_no" required placeholder="Parent's No. (09...)"
                        class="glass-input w-full p-3 rounded-xl placeholder-white/30">
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="toggleModal('modal-add-learner')"
                        class="flex-1 py-3 rounded-xl font-medium text-white/60 hover:bg-white/10 transition-colors">Cancel</button>
                    <button type="submit"
                        class="flex-1 bg-cyan-500 hover:bg-cyan-400 py-3 rounded-xl font-bold text-white shadow-lg transition-transform active:scale-95">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View QR Modal -->
    <div id="modal-view-qr"
        class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-xs p-8 text-center relative">
            <button onclick="toggleModal('modal-view-qr')"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            <h3 id="qr-name" class="text-xl font-bold text-slate-800 mb-1">Student Name</h3>
            <p class="text-xs text-slate-500 mb-6 uppercase tracking-wider font-semibold">Scan to attend</p>

            <div id="qr-display" class="flex justify-center mb-6 mix-blend-multiply"></div>

            <button onclick="printMainQR()"
                class="bg-slate-900 text-white w-full py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-all">
                <i class="fa-solid fa-print mr-2"></i> Print Card
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel bg-slate-900/90 rounded-2xl w-full max-w-sm p-6 border-white/20">
            <h3 class="text-xl font-bold mb-4">Settings</h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs uppercase text-blue-200 font-bold tracking-wider mb-2">SMS Message
                        Template</label>
                    <textarea id="settings-template" rows="4" class="glass-input w-full p-3 rounded-xl text-sm"
                        placeholder="Message content..."></textarea>
                    <p class="text-[10px] text-white/50 mt-2">Available variables: <code
                            class="bg-white/10 px-1 rounded text-cyan-300">{name}</code> <code
                            class="bg-white/10 px-1 rounded text-cyan-300">{time}</code> <code
                            class="bg-white/10 px-1 rounded text-cyan-300">{date}</code></p>
                </div>

                <button onclick="saveSettings()"
                    class="w-full bg-cyan-500 hover:bg-cyan-400 py-3 rounded-xl font-bold text-white shadow-lg active:scale-95 transition-all">
                    Save Changes
                </button>
                <button onclick="toggleModal('modal-settings')"
                    class="w-full py-3 text-white/50 hover:text-white transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- STATE ---
        const store = {
            learners: JSON.parse(localStorage.getItem('learners')) || [],
            logs: JSON.parse(localStorage.getItem('logs')) || [],
            settings: JSON.parse(localStorage.getItem('settings')) || {
                template: "Good day! Your child {name} has arrived at school at {time}."
            },
            scanning: false,
            currentCamera: 'environment' // 'user' or 'environment' or ID
        };

        // --- PERSISTENCE ---
        const save = () => {
            localStorage.setItem('learners', JSON.stringify(store.learners));
            localStorage.setItem('logs', JSON.stringify(store.logs));
            localStorage.setItem('settings', JSON.stringify(store.settings));
        };

        // --- NAVIGATION ---
        function navSwitch(viewId) {
            // Update Btns
            ['scan', 'learners', 'logs'].forEach(id => {
                const btn = document.getElementById(`btn-${id}`);
                const isActive = id === viewId;
                btn.classList.toggle('nav-active', isActive);
                btn.classList.toggle('text-white/60', !isActive);
            });

            // Update Views
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('translate-x-0');
            });
            const target = document.getElementById(`view-${viewId}`);
            target.classList.remove('hidden');
            // Small timeout for transition
            setTimeout(() => target.classList.add('translate-x-0'), 10);

            if (viewId === 'learners') renderLearners();
            if (viewId === 'logs') renderLogs();
        }

        // --- MODALS ---
        function toggleModal(id) {
            const el = document.getElementById(id);
            if (!el.classList.contains('hidden')) {
                // Close
                el.classList.add('hidden');
            } else {
                // Open
                if (id === 'modal-settings') {
                    document.getElementById('settings-template').value = store.settings.template;
                }
                el.classList.remove('hidden');
            }
        }

        // --- SETTINGS ---
        function saveSettings() {
            const tpl = document.getElementById('settings-template').value;
            store.settings.template = tpl;
            save();
            toggleModal('modal-settings');
            alert("Settings saved!");
        }

        // --- LEARNERS ---
        function addLearner(e) {
            e.preventDefault();
            const f = e.target;
            const l = {
                id: Date.now().toString(36),
                name: f.name.value.trim(),
                section: f.section.value.trim(),
                parent_no: f.parent_no.value.trim()
            };
            store.learners.push(l);
            save();
            f.reset();
            toggleModal('modal-add-learner');
            renderLearners();
        }

        function deleteLearner(id) {
            if (confirm("Delete this learner?")) {
                store.learners = store.learners.filter(l => l.id !== id);
                save();
                renderLearners();
            }
        }

        function renderLearners() {
            const c = document.getElementById('learners-list');
            c.innerHTML = store.learners.length ? '' : '<div class="text-white/40 text-center py-10">No learners yet.</div>';

            store.learners.forEach(l => {
                const el = document.createElement('div');
                el.className = "glass-panel rounded-xl p-4 flex justify-between items-center";
                el.innerHTML = `
                    <div>
                        <div class="font-bold text-lg">${l.name}</div>
                        <div class="text-sm text-white/60">${l.section}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showQR('${l.id}')" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors">
                            <i class="fa-solid fa-qrcode"></i>
                        </button>
                        <button onclick="deleteLearner('${l.id}')" class="w-10 h-10 rounded-full bg-red-500/20 text-red-300 hover:bg-red-500/40 flex items-center justify-center transition-colors">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                c.appendChild(el);
            });
        }

        function showQR(id) {
            const l = store.learners.find(x => x.id === id);
            document.getElementById('qr-name').innerText = l.name;
            const box = document.getElementById('qr-display');
            box.innerHTML = '';

            // Payload
            const data = JSON.stringify({ n: l.name, s: l.section, p: l.parent_no });

            new QRCode(box, {
                text: data,
                width: 200,
                height: 200,
                colorDark: "#1e293b",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });
            toggleModal('modal-view-qr');
        }

        function printMainQR() {
            const c = document.getElementById('qr-display').innerHTML;
            const n = document.getElementById('qr-name').innerText;
            const w = window.open('', '');
            w.document.write(`<html><body style="text-align:center; font-family:sans-serif"><h1>${n}</h1>${c}</body></html>`);
            w.print();
            w.close();
        }

        // --- SCANNER --- 
        let scanner = null;

        async function startScanner() {
            if (store.scanning) return;

            // Get Camera Selection
            const mode = document.getElementById('camera-select').value;
            store.currentCamera = mode;

            scanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            try {
                await scanner.start(
                    { facingMode: mode }, // user or environment
                    config,
                    onScan,
                    undefined
                );
                store.scanning = true;
                updateScanUI(true);
            } catch (err) {
                console.error(err);
                alert("Camera error: " + err);
            }
        }

        async function stopScanner() {
            if (!scanner) return;
            try {
                await scanner.stop();
                scanner.clear();
                store.scanning = false;
                updateScanUI(false);
            } catch (e) { console.error(e); }
        }

        async function restartScanner() {
            if (store.scanning) {
                await stopScanner();
                await startScanner();
            }
        }

        function updateScanUI(active) {
            document.getElementById('camera-placeholder').classList.toggle('hidden', active);
            document.getElementById('controls-inactive').classList.toggle('hidden', active);
            document.getElementById('controls-active').classList.toggle('hidden', !active);
        }

        // --- LOGIC ---
        let lastScan = 0;

        function onScan(txt) {
            const now = Date.now();
            if (now - lastScan < 4000) return; // 4s cooldown
            lastScan = now;

            try {
                const data = JSON.parse(txt);
                if (!data.n) throw "Invalid Data";

                handleAttendance(data);
            } catch (e) {
                logFeedback("Invalid QR Code scanned", "error");
            }
        }

        function handleAttendance(data) {
            const d = new Date();
            const timeStr = d.toLocaleTimeString();
            const dateStr = d.toLocaleDateString();

            const entry = {
                name: data.n,
                section: data.s,
                date: dateStr,
                time: timeStr,
                status: 'present'
            };

            store.logs.push(entry);
            save(); // Save immediately

            logFeedback(`Marked ${data.n} as present`, "success");

            // SMS Trigger
            if (data.p) {
                const msg = formatMessage(store.settings.template, {
                    name: data.n,
                    time: timeStr,
                    date: dateStr
                });

                // Construct SMS Link
                const link = `sms:${data.p}?body=${encodeURIComponent(msg)}`;

                // Show toast & Redirect
                logFeedback("Opening SMS...", "info");

                // We use a slight delay so the UI updates first
                setTimeout(() => {
                    window.location.href = link;
                }, 100);
            } else {
                logFeedback("No parent number linked", "warning");
            }
        }

        function formatMessage(tpl, vars) {
            return tpl.replace(/{(\w+)}/g, (match, key) => {
                return typeof vars[key] !== 'undefined' ? vars[key] : match;
            });
        }

        function logFeedback(msg, type) {
            const c = document.getElementById('live-feedback');
            const div = document.createElement('div');

            let icon = "fa-circle-info";
            let color = "bg-blue-500/20 text-blue-200 border-blue-500/50"; // default info

            if (type === 'success') {
                icon = "fa-check";
                color = "bg-green-500/20 text-green-200 border-green-500/50";
            } else if (type === 'error') {
                icon = "fa-xmark";
                color = "bg-red-500/20 text-red-200 border-red-500/50";
            } else if (type === 'warning') {
                icon = "fa-triangle-exclamation";
                color = "bg-yellow-500/20 text-yellow-200 border-yellow-500/50";
            }

            div.className = `glass-panel ${color} border-l-4 p-4 rounded-xl flex items-center gap-3 animate-slide-in-right`;
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center shrink-0">
                    <i class="fa-solid ${icon}"></i>
                </div>
                <div>
                     <p class="text-sm font-medium">${msg}</p>
                     <p class="text-[10px] opacity-60 uppercase tracking-wide">${new Date().toLocaleTimeString()}</p>
                </div>
            `;

            c.prepend(div);
            // Limit history
            if (c.children.length > 5) c.lastElementChild.remove();
        }

        // --- LOGS ---
        function renderLogs() {
            const c = document.getElementById('logs-list');
            const logs = [...store.logs].reverse();
            c.innerHTML = logs.length ? '' : '<tr><td colspan="3" class="p-4 text-center text-white/40">No records</td></tr>';

            logs.forEach(l => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 font-mono text-white/70">${l.time}</td>
                    <td class="p-3 font-medium">${l.name}</td>
                    <td class="p-3 text-right"><span class="bg-green-500/20 text-green-300 text-[10px] px-2 py-1 rounded-full uppercase font-bold">Present</span></td>
                `;
                c.appendChild(tr);
            });
        }

        function exportLogs() {
            const csv = store.logs.map(l => `${l.date},${l.time},${l.name},${l.section}`).join('\n');
            const blob = new Blob(["Date,Time,Name,Section\n" + csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "attendance_logs.csv";
            a.click();
        }
    </script>
</body>

</html>
